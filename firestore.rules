
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to get the user's role from the 'users' collection
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    // Helper function to check if the user has one of the specified roles
    function hasRole(roles) {
      return isSignedIn() && getUserRole(request.auth.uid) in roles;
    }
    
    // Allow public read on blog posts that are published
    match /blog/{postId} {
        allow read: if resource.data.isPublished == true;
        // Only admins and superadmins can create, update, or delete blog posts
        allow write: if hasRole(['admin', 'superadmin']);
    }
    
    // Public can read dormitories and halls for booking purposes
    match /dormitories/{dormId} {
        allow read: if true;
        // Only admins can manage dormitories
        allow write: if hasRole(['admin', 'superadmin']);
    }
    
    match /halls/{hallId} {
        allow read: if true;
        // Only general admins can manage halls
        allow write: if hasRole(['admin', 'superadmin']); 
    }

    // Bookings can be created by anyone, but only specific roles can manage them
    match /bookings/{bookingId} {
      allow read: if isSignedIn(); // Logged-in users can read bookings (e.g., their own)
      allow create: if true; // Anyone can submit a booking request
      allow update, delete: if hasRole(['admin', 'superadmin']); // Admins can manage all bookings
    }

    // User documents management
    match /users/{userId} {
      // Allow user to read and update their own document
      allow read, update: if request.auth.uid == userId;
      // Allow superadmins to read, create, update, delete any user document
      allow write: if hasRole(['superadmin']);
      // Allow general admins to read company reps
      allow read: if hasRole(['admin']);
    }
    
    // Notifications are only for admins
    match /notifications/{notificationId} {
        allow read, write: if hasRole(['admin', 'superadmin']);
    }

    // Site configuration documents
    match /site_configuration/{docId} {
        allow read: if true; // Public can read configs like pricing, site content
        allow write: if hasRole(['admin', 'superadmin']); // Only admins can change settings
    }
    
    // Store Items and Transactions
    match /store_items/{itemId} {
        allow read: if hasRole(['store_manager', 'admin', 'superadmin']);
        allow write: if hasRole(['store_manager', 'admin', 'superadmin']);
    }
    
    match /store_transactions/{transactionId} {
        allow read: if hasRole(['store_manager', 'admin', 'superadmin']);
        allow create: if hasRole(['store_manager']);
        allow update, delete: if hasRole(['admin', 'superadmin']);
    }

    // Employees collection
    match /employees/{employeeId} {
        allow read: if hasRole(['store_manager', 'admin', 'superadmin']);
        allow write: if hasRole(['admin', 'superadmin']);
    }
  }
}
